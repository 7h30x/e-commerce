<!DOCTYPE html >
<html lang="en">
<head>
  <title>Log In</title>
  <link href="./style.css" rel="stylesheet" type="text/css">
  <script src="https://apis.google.com/js/platform.js" async defer></script>
  <meta name="google-signin-client_id" content="803894408351-8uclep7lb8052h78vhoofq8vs77ahub5.apps.googleusercontent.com">

  <!-- load jquery script from google cdn -->
</head>
<body>
  <h1>Sign In</h1>
  <form id ="signIn">
    <input type = "text" id = "email" placeholder = "enter email" required>
    <input type = "password" id = "password" placeholder = "enter password" required>
    <input type = "submit" value="Sign in">
  </form>
  <div class="g-signin2" data-onsuccess="onSignIn"></div>
  <p id="msg"></p>
  <a href="registration.html">Register as new user</a>

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script src="https://apis.google.com/js/client:platform.js?onload=start" async defer></script><!-- load google auth2 lib -->
  <script>
      function start() {
        gapi.load('auth2', function() {
          auth2 = gapi.auth2.init({
            //scope: 'additional_scope'
          });
        });
      }
      function onSignIn(googleUser) {
        var id_token = googleUser.getAuthResponse().id_token;
        $.ajax({
            type: 'POST',
            url: 'http://localhost:3000/gSignIn',
            headers: {
              'X-Requested-With': 'XMLHttpRequest',
              'token': id_token
            },
            contentType: 'application/json',
            success: function(result) {
              //store result in localstorage & redirect to index as USER
              window.location.replace('http://localhost:8080/index.html')
            },
            processData: false,
          })
        }

  </script>
  <script>
    $("document").ready(() => {
      
      $("#signIn").submit(function() {
        const signInData = {
          email : $("#email").val(),
          password : $("#password").val()
        }
        $.post('http://localhost:3000/signIn' , signInData)
        .then( res => {
            localStorage.setItem ("token", res.token)
            $("#msg").html('success! Redirecting you to index page...');
            setTimeout( function () {
              window.location("http://localhost:8080/index.html")},
              1000)
        })
        .catch( err => $("#msg").html(err.responseJSON)
        );

       

        return false;
      })
    })
    
  </script>
  
</body>

</html>